---
title: "Downloading"
format:
  html:
    echo: true
    code-fold: false
---

A copy of the script that is used to download and munge the latin DATRAS data:

```{r}
#| eval: false
library(obus)
library(tidyverse)
surveys <- c("BITS", "BTS", "BTS-GSA17", "BTS-VIII",
             "Can-Mar", "DWS", "DYFS", "EVHOE", "FR-CGFS", "FR-WCGFS",
             "IE-IAMS", "IE-IGFS", "IS-IDPS", "NIGFS", "NL-BSAS",
             "NS-IBTS", "NS-IDPS", "NSSS", "PT-IBTS", "ROCKALL",
             "SCOROC", "SCOWCGFS", "SE-SOUND", "SNS", "SP-ARSA",
             "SP-NORTH", "SP-PORC", "SWC-IBTS")
years <- "1965:2030"
quarters <- "1:4"
outpath <- "/home/hafri/einarhj/public_html/datras_latin/raw"
system.time({
  for (i in 1:length(surveys)) {
    print(paste(i, surveys[i]))
    hh <-
      dr_get_data_latin("HH", surveys[i], years, quarters) |>
      obus:::dr_settypes() |>
      dplyr::mutate(.id = paste(Survey, Year, Quarter, Country, Ship, Gear, StNo, HaulNo, sep=":"),
                    sur = paste0(Survey, "-", Quarter),
                    .before = 1)
    hh[hh == -9 | hh == "-9"] <- NA
    if (nrow(hh) >= 1) {
      hh |> dplyr::group_by(RecordType, Survey) |>
        arrow::write_dataset(path = outpath)
    }
    hl <-
      dr_get_data_latin("HL", surveys[i], years, quarters) |>
      obus:::dr_settypes() |>
      dplyr::mutate(.id = paste(Survey, Year, Quarter, Country, Ship, Gear, StNo, HaulNo, sep=":"),
                    sur = paste0(Survey, "-", Quarter),
                    .before = 1)
    hl[hl == -9 | hl == "-9"] <- NA
    if (nrow(hl) >= 1) {
      hl |> dplyr::group_by(RecordType, Survey) |>
        arrow::write_dataset(path = outpath)
    }
    ca <-
      dr_get_data_latin("CA", surveys[i], years, quarters) |>
      obus:::dr_settypes() |>
      dplyr::mutate(.id = paste(Survey, Year, Quarter, Country, Ship, Gear, StNo, HaulNo, sep=":"),
                    sur = paste0(Survey, "-", Quarter),
                    .before = 1)
    ca[ca == -9 | ca == "-9"] <- NA
    if (nrow(ca) >= 1) {
      ca |> dplyr::group_by(RecordType, Survey) |>
        arrow::write_dataset(path = outpath)
    }
  }
})

duckdbfs::open_dataset(paste0(outpath, "/RecordType=HH")) |>
  duckdbfs::write_dataset("/home/hafri/einarhj/public_html/datras_latin/HH.parquet")
duckdbfs::open_dataset(paste0(outpath, "/RecordType=HL")) |>
  duckdbfs::write_dataset("/home/hafri/einarhj/public_html/datras_latin/HL.parquet")
duckdbfs::open_dataset(paste0(outpath, "/RecordType=CA")) |>
  duckdbfs::write_dataset("/home/hafri/einarhj/public_html/datras_latin/CA.parquet")

system("chmod -R a+r /home/hafri/einarhj/public_html/datras_latin")
hh <-
  duckdbfs::open_dataset("https://heima.hafro.is/~einarhj/datras_latin/HH.parquet") |>
  dr_tidy() |>
  select(.id, survey, year, quarter, lon = shootlong, lat = shootlat)
hl <-
  duckdbfs::open_dataset("https://heima.hafro.is/~einarhj/datras_latin/HL.parquet") |>
  dr_tidy() |>
  mutate(length = floor(length),
         length = as.integer(length),
         b = hlnoatlngt * 1e-5 * length^3) |>
  select(.id, latin = scientificname_worms, length, n = hlnoatlngt, b) |>
  # length has been floored
  group_by(.id, latin, length) |>
  summarise(n = sum(n, na.rm = TRUE),
            b = sum(b, na.rm = TRUE),
            .groups = "drop") |>
  left_join(hh |> select(.id, survey, year, quarter))
by.length <-
  hl |>
  group_by(survey, year, quarter, latin, length) |>
  summarise(n = sum(n, na.rm = TRUE),
            b = sum(b, na.rm = TRUE),
            .groups = "drop")
by.station <-
  hl |>
  group_by(.id, latin) |>
  summarise(n = sum(n, na.rm = TRUE),
            b = sum(b, na.rm = TRUE),
            .groups = "drop")

hh |>
  mutate(survey = paste0(survey, "-", quarter)) |>
  select(-quarter) |>
  duckdbfs::write_dataset("/home/hafri/einarhj/public_html/datras_latin/haul.parquet")
by.length |>
  mutate(survey = paste0(survey, "-", quarter)) |>
  select(-quarter) |>
  duckdbfs::write_dataset("/home/hafri/einarhj/public_html/datras_latin/by_length.parquet")
by.station |>
  duckdbfs::write_dataset("/home/hafri/einarhj/public_html/datras_latin/by_station.parquet")
system("chmod -R a+r /home/hafri/einarhj/public_html/datras_latin")
```


